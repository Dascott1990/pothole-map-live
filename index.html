<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DeepSeek — Global Pothole Map & Learning</title>

<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
  :root{
    --bg1: #0f172a; --bg2:#0b1220;
    --card:#0f172a; --glass: rgba(255,255,255,0.04);
    --accent:#4f46e5; --accent-2:#06b6d4; --muted:#94a3b8;
    --radius:12px; --shadow: 0 10px 30px rgba(2,6,23,0.6);
    --glass-2: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
  body{
    background: linear-gradient(180deg,var(--bg1) 0%, #081028 60%);
    color: #e6eef8; -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    min-height:100vh; display:flex; flex-direction:column;
  }

  /* Header */
  header{position:sticky; top:0; z-index:60; backdrop-filter: blur(6px); background: linear-gradient(180deg, rgba(2,6,23,0.6), rgba(2,6,23,0.4)); box-shadow: 0 2px 14px rgba(2,6,23,0.6); }
  .container{max-width:1200px;margin:0 auto;padding:14px;}
  .header-row{display:flex;align-items:center;justify-content:space-between;gap:12px;}
  .brand{display:flex;align-items:center;gap:12px}
  .brand h1{font-size:18px;margin:0;color:linear-gradient(90deg,var(--accent), var(--accent-2));}
  .nav{display:flex;gap:14px;align-items:center}
  .nav a{color:var(--muted);text-decoration:none;padding:8px 12px;border-radius:10px;transition:all .18s}
  .nav a.active, .nav a:hover{background:var(--glass-2); color:#fff; transform:translateY(-2px)}
  .hamburger{display:none;cursor:pointer; width:34px; height:26px; flex-direction:column; justify-content:space-between}
  .hamburger span{display:block;height:3px;background:#fff;border-radius:4px}

  /* Layout */
  .main{display:grid;grid-template-columns:360px 1fr;gap:18px;align-items:start;padding:22px;flex:1;}
  @media(max-width:1000px){.main{grid-template-columns:1fr;}.sidebar{order:2}.content{order:1}}
  .sidebar{background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:18px; border-radius:var(--radius); box-shadow:var(--shadow); min-height:280px}
  .content{background:transparent; border-radius:var(--radius); padding:10px; display:flex;flex-direction:column; gap:16px}

  /* Globe card */
  .globe-card{
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:14px; padding:8px; box-shadow: var(--shadow); overflow:hidden;
  }
  #globeWrap{height:560px;border-radius:12px; background:radial-gradient(circle at 30% 20%, rgba(79,70,229,0.08), transparent 10%), #020617; display:flex;align-items:center;justify-content:center; position:relative}
  canvas {display:block; width:100%; height:100%;}

  /* Controls overlay */
  .globe-controls{position:absolute; right:12px; top:12px; display:flex;flex-direction:column; gap:8px; z-index:10}
  .chip{background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02)); padding:8px 10px; border-radius:10px; color:var(--muted); display:flex;gap:8px; align-items:center; font-size:13px}
  .chip strong{color:#fff}

  /* Comments & reports pane */
  .reports{display:flex;flex-direction:column; gap:12px; margin-top:8px}
  .report-list{max-height:260px; overflow:auto; padding:8px; border-radius:10px; background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent)}
  .report{padding:10px;border-radius:8px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); margin-bottom:8px; display:flex;justify-content:space-between; gap:8px}
  .report .meta{color:var(--muted);font-size:12px}
  .report .txt{font-size:14px;color:#e6eef8}

  /* Comment box */
  .comment-box{display:flex; gap:8px; margin-top:10px}
  .comment-box textarea{flex:1; min-height:56px; border-radius:10px; border:1px solid rgba(255,255,255,0.04); padding:10px; background:transparent; color:#fff}
  .btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:600}
  .btn-primary{background:linear-gradient(90deg,var(--accent), var(--accent-2)); color:#fff}
  .btn-ghost{background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.03)}

  /* Small UI */
  .section-title{font-size:14px;color:var(--muted);display:flex;align-items:center;gap:8px}
  .section-title h3{margin:0;font-size:16px;color:#fff}

  /* Notes area (local) */
  .notes{margin-top:12px}
  textarea#noteInput{min-height:80px;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#fff;width:100%}

  footer{padding:16px;border-top:1px solid rgba(255,255,255,0.02); color:var(--muted); text-align:center; font-size:13px}
  .muted{color:var(--muted)}

  /* Mobile nav show */
  @media(max-width:768px){
    .nav{display:none}
    .hamburger{display:flex}
    .mobile-nav{position:fixed; left:-100%; top:64px; right:0; background:linear-gradient(180deg,#07102a,#031021); padding:18px; transition:left .28s; z-index:70; border-top:1px solid rgba(255,255,255,0.02)}
    .mobile-nav.show{left:0}
    .mobile-nav a{display:block;padding:12px;border-radius:10px;color:var(--muted); margin-bottom:6px}
    .main{padding:14px}
    #globeWrap{height:420px}
  }
</style>
</head>
<body>
<header>
  <div class="container header-row">
    <div class="brand">
      <i class="fas fa-globe-americas" style="font-size:22px;color:var(--accent)"></i>
      <h1>DeepSeek • Pothole Map</h1>
    </div>
    <nav class="nav" aria-label="Main navigation">
      <a href="#" class="active" data-page="home">Home</a>
      <a href="#" data-page="modules">Modules</a>
      <a href="#" data-page="resources">Resources</a>
      <a href="#" data-page="community">Community</a>
      <a href="#" data-page="about">About</a>
    </nav>

    <div style="display:flex;align-items:center;gap:12px">
      <div class="hamburger" id="hamburger" aria-label="Open menu" role="button">
        <span></span><span></span><span></span>
      </div>
    </div>
  </div>

  <!-- mobile nav -->
  <div class="mobile-nav container" id="mobileNav" aria-hidden="true" style="display:none">
    <a href="#" data-page="home">Home</a>
    <a href="#" data-page="modules">Modules</a>
    <a href="#" data-page="resources">Resources</a>
    <a href="#" data-page="community">Community</a>
    <a href="#" data-page="about">About</a>
  </div>
</header>

<main class="container main" role="main">
  <!-- Sidebar: learning flow + notes (keeps your local notes behavior) -->
  <aside class="sidebar" aria-labelledby="sidebarTitle">
    <div class="section-title"><h3 id="sidebarTitle">Learning Flow</h3></div>

    <div style="margin-top:12px; display:flex;flex-direction:column;gap:8px">
      <div class="chip"><i class="fas fa-lightbulb"></i><div style="margin-left:6px">Start with the Overview → then click the globe to report potholes</div></div>
      <div class="chip"><i class="fas fa-users"></i><div style="margin-left:6px">Community reports are shared globally</div></div>
    </div>

    <div class="notes">
      <h4 style="margin:12px 0 6px 0;">My Notes</h4>
      <div id="notesContainerLocal" style="min-height:80px; background:linear-gradient(180deg, rgba(255,255,255,0.01),transparent); border-radius:10px; padding:8px; max-height:220px; overflow:auto">
        <!-- local notes appear here -->
      </div>
      <textarea id="noteInput" placeholder="Add your local note..."></textarea>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn btn-primary" id="addNoteBtn"><i class="fas fa-plus"></i> Add Note</button>
        <button class="btn btn-ghost" id="clearNotesBtn"><i class="fas fa-trash"></i> Clear Notes</button>
      </div>
    </div>

    <div style="margin-top:14px">
      <div class="section-title"><h3>Progress</h3></div>
      <div style="margin-top:8px; font-size:13px; color:var(--muted)" id="progressText">Start your journey</div>
      <div style="height:8px;background:rgba(255,255,255,0.02);border-radius:8px;margin-top:8px">
        <div id="progressFillLocal" style="height:8px;width:18%;background:linear-gradient(90deg,var(--accent),var(--accent-2));border-radius:8px"></div>
      </div>
    </div>

    <div style="margin-top:14px">
      <div class="section-title"><h3>Clock</h3></div>
      <div id="clockSmall" style="margin-top:8px;font-family:monospace; font-size:14px"></div>
    </div>
  </aside>

  <!-- Content -->
  <section class="content" aria-labelledby="globeTitle">
    <div class="globe-card">
      <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 12px">
        <div>
          <div class="section-title"><h3 id="globeTitle">Global 3D Live Map</h3></div>
          <div style="font-size:13px;color:var(--muted)">Click on the globe to report potholes. Reports appear instantly for all users.</div>
        </div>

        <div style="display:flex;gap:10px;align-items:center">
          <div class="chip" id="connectedStatus"><i class="fas fa-wifi"></i><strong>Offline</strong></div>
          <button class="btn btn-ghost" id="btnCenter"><i class="fas fa-crosshairs"></i> Center</button>
        </div>
      </div>

      <div id="globeWrap">
        <!-- three.js canvas will mount here -->
      </div>

      <div style="display:flex;gap:12px;padding:12px;flex-wrap:wrap;align-items:center;justify-content:space-between">
        <div style="flex:1">
          <div style="font-size:13px;color:var(--muted)">Pothole Feed</div>
          <div class="report-list" id="globalReports">
            <!-- global realtime pothole reports (Firestore) -->
          </div>
        </div>

        <div style="width:320px">
          <div style="font-size:13px;color:var(--muted)">Global Comments</div>
          <div class="report-list" id="globalComments" aria-live="polite">
            <!-- global comments feed -->
          </div>

          <div class="comment-box" style="margin-top:8px">
            <textarea id="commentInput" placeholder="Share what you learned — visible to everyone"></textarea>
            <button class="btn btn-primary" id="postCommentBtn"><i class="fas fa-paper-plane"></i></button>
          </div>
        </div>
      </div>
    </div>

    <!-- Additional pages placeholders (Modules/Resources/Community/About) -->
    <div id="pagePanels" style="margin-top:12px; display:grid; gap:12px">
      <div class="globe-card" id="homePanel"><div style="padding:14px"><h3>Home • Overview</h3><p style="color:var(--muted)">This learning platform combines practical labs, code walkthroughs and the live map. Use the globe to collect real data.</p></div></div>

      <div class="globe-card" id="modulesPanel" style="display:none"><div style="padding:14px"><h3>Modules</h3><p style="color:var(--muted)">Module pages coming soon — structured labs, code snippets and tests for pothole detection.</p></div></div>

      <div class="globe-card" id="resourcesPanel" style="display:none"><div style="padding:14px"><h3>Resources</h3><p style="color:var(--muted)">Datasets, tools and tutorials will appear here.</p></div></div>

      <div class="globe-card" id="communityPanel" style="display:none"><div style="padding:14px"><h3>Community</h3><p style="color:var(--muted)">Realtime discussions and collaboration space.</p></div></div>

      <div class="globe-card" id="aboutPanel" style="display:none"><div style="padding:14px"><h3>About</h3><p style="color:var(--muted)">Mission: unify global road safety through community-sourced mapping.</p></div></div>
    </div>
  </section>
</main>

<footer>
  <div class="container">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
      <div class="muted">© <strong>DeepSeek</strong> — Pothole Detection Learning • Built for a global community</div>
      <div class="muted">Page loaded: <span id="pageLoadedAt"></span></div>
    </div>
  </div>
</footer>

<!-- Three.js & OrbitControls (non-module) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r152/three.min.js"></script>
<script src="https://threejs.org/examples/js/controls/OrbitControls.js"></script>

<!-- Firebase (compat libraries used for simpler integration in a single-file demo)
     Replace firebaseConfig below with your project's config -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
/*
  IMPORTANT: Replace the firebaseConfig object below with your Firebase project's config.
  You can find it in your Firebase console -> Project settings -> SDK setup (Web).
*/
const firebaseConfig = {
  apiKey: "REPLACE_API_KEY",
  authDomain: "REPLACE_PROJECT.firebaseapp.com",
  projectId: "REPLACE_PROJECT",
  storageBucket: "REPLACE_PROJECT.appspot.com",
  messagingSenderId: "REPLACE_SENDER",
  appId: "REPLACE_APPID"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// helper to format timestamp
function fmtTS(ts){
  try{
    const d = ts.toDate ? ts.toDate() : new Date(ts);
    return d.toLocaleString();
  }catch(e){ return String(ts) }
}

/*---------------------------
  Real-time Firestore listeners
  Collections: "potholes" (geolocated reports), "comments" (global comments)
----------------------------*/
const reportsContainer = document.getElementById('globalReports');
const commentsContainer = document.getElementById('globalComments');
const connectedStatus = document.getElementById('connectedStatus');

// sync connection status
firebase.firestore().enablePersistence({synchronizeTabs:true}).catch(()=>{ /* ignore for demo */ });

function setConnected(ok){
  connectedStatus.innerHTML = ok ? '<i class="fas fa-wifi"></i><strong>Connected</strong>' : '<i class="fas fa-plug-circle-xmark"></i><strong>Offline</strong>';
}

// realtime pothole stream
db.collection('potholes').orderBy('createdAt','desc').limit(200).onSnapshot(snapshot=>{
  reportsContainer.innerHTML = '';
  snapshot.docs.forEach(doc=>{
    const data = doc.data();
    const el = document.createElement('div'); el.className='report';
    el.innerHTML = `<div>
      <div class="txt">${escapeHtml(data.text)}</div>
      <div class="meta">${data.severity ? 'Severity: '+data.severity+' • ' : ''}${fmtTS(data.createdAt)}</div>
    </div>
    <div style="min-width:76px;text-align:right;color:var(--muted);font-size:12px">${data.lat.toFixed(3)}, ${data.lon.toFixed(3)}</div>`;
    reportsContainer.appendChild(el);
  });
});

// realtime comments stream
db.collection('comments').orderBy('createdAt','desc').limit(200).onSnapshot(snapshot=>{
  commentsContainer.innerHTML = '';
  snapshot.docs.forEach(doc=>{
    const data = doc.data();
    const el = document.createElement('div'); el.className='report';
    el.innerHTML = `<div>
      <div class="txt">${escapeHtml(data.text)}</div>
      <div class="meta">${data.name ? escapeHtml(data.name) + ' • ' : ''}${fmtTS(data.createdAt)}</div>
    </div>`;
    commentsContainer.appendChild(el);
  });
  setConnected(true);
}, err=>{
  console.error('comments listener error',err);
  setConnected(false);
});

/*---------------------------
  Post a global comment (visible to all)
----------------------------*/
document.getElementById('postCommentBtn').addEventListener('click', async ()=>{
  const t = document.getElementById('commentInput').value.trim();
  if(!t) return alert('Please write something to share.');
  const comment = { text: t, createdAt: firebase.firestore.FieldValue.serverTimestamp(), name: 'Community' };
  try{
    await db.collection('comments').add(comment);
    document.getElementById('commentInput').value='';
  }catch(e){
    console.error(e); alert('Failed to post comment.');
  }
});

/*---------------------------
  Local notes (localStorage) — preserved behavior from your original file
----------------------------*/
const notesContainerLocal = document.getElementById('notesContainerLocal');
const noteInput = document.getElementById('noteInput');
const addNoteBtn = document.getElementById('addNoteBtn');
const clearNotesBtn = document.getElementById('clearNotesBtn');

function loadLocalNotes(){
  const notes = JSON.parse(localStorage.getItem('deepseek_local_notes')||'[]');
  notesContainerLocal.innerHTML = notes.length ? '' : '<div style="color:var(--muted)">No local notes yet.</div>';
  notes.forEach(n=>{
    const d = document.createElement('div'); d.className='report'; d.innerHTML = `<div><div class="txt">${escapeHtml(n.text)}</div><div class="meta">${new Date(n.ts).toLocaleString()}</div></div>`;
    notesContainerLocal.appendChild(d);
  });
}
function saveLocalNote(text){
  const notes = JSON.parse(localStorage.getItem('deepseek_local_notes')||'[]');
  notes.unshift({ text, ts: Date.now() });
  localStorage.setItem('deepseek_local_notes', JSON.stringify(notes));
  loadLocalNotes();
}
addNoteBtn.addEventListener('click', ()=>{ const t = noteInput.value.trim(); if(!t) return; saveLocalNote(t); noteInput.value=''; });
clearNotesBtn.addEventListener('click', ()=>{ if(confirm('Clear local notes?')){ localStorage.removeItem('deepseek_local_notes'); loadLocalNotes(); } });
loadLocalNotes();

/*---------------------------
  THREE.JS Globe
----------------------------*/
let scene, camera, renderer, controls, globe, raycaster, pointer;
const globeWrap = document.getElementById('globeWrap');

function initThree(){
  // renderer
  renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
  renderer.setPixelRatio(window.devicePixelRatio);
  renderer.setSize(globeWrap.clientWidth, globeWrap.clientHeight, false);
  globeWrap.appendChild(renderer.domElement);

  // scene & camera
  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera(35, globeWrap.clientWidth / globeWrap.clientHeight, 0.1, 2000);
  camera.position.set(0, 0, 6);

  // lights
  const ambient = new THREE.AmbientLight(0xffffff, 0.65);
  const dir = new THREE.DirectionalLight(0xffffff, 0.5);
  dir.position.set(5,3,5);
  scene.add(ambient, dir);

  // globe geometry & material (earth texture)
  const geometry = new THREE.SphereGeometry(2.0, 64, 64);
  const textureLoader = new THREE.TextureLoader();
  const earthTex = textureLoader.load('https://threejs.org/examples/textures/land_ocean_ice_cloud_2048.jpg');
  const material = new THREE.MeshStandardMaterial({ map: earthTex, roughness: 1.0, metalness: 0.0 });
  globe = new THREE.Mesh(geometry, material);
  globe.name = 'earth';
  scene.add(globe);

  // subtle atmosphere glow
  const atmosphereGeo = new THREE.SphereGeometry(2.05, 64, 64);
  const atmosphereMat = new THREE.MeshBasicMaterial({ color: 0x8ab6ff, blending: THREE.AdditiveBlending, side: THREE.BackSide, transparent:true, opacity:0.06 });
  const atmosphere = new THREE.Mesh(atmosphereGeo, atmosphereMat);
  scene.add(atmosphere);

  // controls
  controls = new THREE.OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;
  controls.dampingFactor = 0.08;
  controls.rotateSpeed = 0.5;
  controls.minDistance = 3.0;
  controls.maxDistance = 10;

  // raycaster for clicks
  raycaster = new THREE.Raycaster();
  pointer = new THREE.Vector2();

  // handle resize
  window.addEventListener('resize', onResize);
  renderer.domElement.addEventListener('pointerdown', onPointerDown);

  // start animation
  animate();
  // load existing potholes to markers
  bindPotholeMarkersRealtime();
}

function onResize(){
  renderer.setSize(globeWrap.clientWidth, globeWrap.clientHeight);
  camera.aspect = globeWrap.clientWidth / globeWrap.clientHeight;
  camera.updateProjectionMatrix();
}

/* markers group */
const markers = new THREE.Group();
scene && scene.add(markers);

/* Convert lat/lon to 3D vector on sphere radius */
function latLonToVector3(lat, lon, radius = 2.0) {
  const phi = (90 - lat) * (Math.PI / 180);
  const theta = (lon + 180) * (Math.PI / 180);
  const x = -(radius * Math.sin(phi) * Math.cos(theta));
  const z = radius * Math.sin(phi) * Math.sin(theta);
  const y = radius * Math.cos(phi);
  return new THREE.Vector3(x, y, z);
}

/* Create or update a marker for a pothole */
const markerObjects = {}; // id => marker mesh
function createMarker(id, lat, lon, severity = 'medium'){
  if(!scene) return;
  // if exists, update
  if(markerObjects[id]) return;
  const color = severity === 'severe' ? 0xff4d4f : (severity === 'minor' ? 0xffc107 : 0x4ade80);
  const geom = new THREE.SphereGeometry(0.045, 12, 12);
  const mat = new THREE.MeshStandardMaterial({ color });
  const marker = new THREE.Mesh(geom, mat);
  const pos = latLonToVector3(lat, lon, 2.02);
  marker.position.copy(pos);
  // make markers always oriented outward and slightly above surface
  marker.lookAt(pos.clone().multiplyScalar(2));
  markers.add(marker);
  markerObjects[id] = marker;

  // subtle pulsing scale animation
  let scaleUp = true;
  (function pulse(){
    if(!marker) return;
    const s = 1 + 0.06 * Math.sin(Date.now()/350);
    marker.scale.set(s,s,s);
    requestAnimationFrame(pulse);
  })();
}

/* Realtime binding to update markers as Firestore updates potholes collection */
function bindPotholeMarkersRealtime(){
  db.collection('potholes').onSnapshot(snapshot=>{
    snapshot.docChanges().forEach(change=>{
      const id = change.doc.id;
      const data = change.doc.data();
      if(change.type === 'added' || change.type === 'modified'){
        createMarker(id, data.lat, data.lon, data.severity||'medium');
      } else if(change.type === 'removed'){
        const m = markerObjects[id];
        if(m){ markers.remove(m); delete markerObjects[id]; }
      }
    });
  }, err=>{
    console.error('pothole stream error',err);
  });
}

/* When user clicks globe, raycast to sphere and get lat/lon then prompt to save to Firestore */
async function onPointerDown(event){
  const rect = renderer.domElement.getBoundingClientRect();
  pointer.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
  pointer.y = - ((event.clientY - rect.top) / rect.height) * 2 + 1;
  raycaster.setFromCamera(pointer, camera);
  const intersects = raycaster.intersectObject(globe);
  if(intersects.length > 0){
    const p = intersects[0].point.clone().normalize();
    // convert to lat/lon
    const lat = 90 - (Math.acos(p.y) * 180 / Math.PI);
    const lon = ((Math.atan2(p.z, -p.x) * 180 / Math.PI) - 180) * -1;
    // prompt user for short details
    const text = prompt(`Report pothole at\nlat: ${lat.toFixed(5)} lon: ${lon.toFixed(5)}\n\nShort description:`);
    if(!text) return;
    const severity = prompt('Severity? (minor / medium / severe)', 'medium') || 'medium';
    const payload = { text, severity, lat: lat, lon: lon, createdAt: firebase.firestore.FieldValue.serverTimestamp() };
    try{
      await db.collection('potholes').add(payload);
      alert('Report posted — visible globally.');
    }catch(e){
      console.error(e); alert('Failed to post report.');
    }
  }
}

/* center camera quickly */
document.getElementById('btnCenter').addEventListener('click', ()=>{ controls.reset(); camera.position.set(0,0,6); });

/* THREE loop */
function animate(){
  requestAnimationFrame(animate);
  // slow rotation for ambience
  if(globe) globe.rotation.y += 0.0006;
  controls && controls.update();
  renderer && renderer.render(scene, camera);
}

/* start Three */
initThree();

/*---------------------------
  Utility: escape HTML
----------------------------*/
function escapeHtml(str){
  return String(str).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
}

/*---------------------------
  Simple SPA nav
----------------------------*/
const navLinks = document.querySelectorAll('nav a');
const mobileLinks = document.querySelectorAll('.mobile-nav a');
const panels = { home: document.getElementById('homePanel'), modules:document.getElementById('modulesPanel'), resources:document.getElementById('resourcesPanel'), community:document.getElementById('communityPanel'), about:document.getElementById('aboutPanel')};

function showPage(page){
  Object.values(panels).forEach(p=>p.style.display='none');
  panels[page].style.display='block';
  navLinks.forEach(a=>a.classList.toggle('active', a.getAttribute('data-page')===page));
}
navLinks.forEach(a=>a.addEventListener('click', e=>{ e.preventDefault(); showPage(a.dataset.page); window.scrollTo({top:0,behavior:'smooth'}); }));
mobileLinks.forEach(a=>a.addEventListener('click', e=>{ e.preventDefault(); showPage(a.dataset.page); toggleMobileMenu(); }));

/* mobile hamburger */
const hamburger = document.getElementById('hamburger');
const mobileNav = document.getElementById('mobileNav');
hamburger.addEventListener('click', toggleMobileMenu);
function toggleMobileMenu(){ mobileNav.style.display = mobileNav.style.display === 'block' ? 'none' : 'block'; }

/* small clock */
function updateClockSmall(){
  document.getElementById('clockSmall').textContent = new Date().toLocaleString();
}
setInterval(updateClockSmall,1000); updateClockSmall();

/* page load timestamp */
document.getElementById('pageLoadedAt').textContent = new Date().toLocaleString();

/* basic connection check for Firestore */
setInterval(async ()=>{
  try{
    await db.collection('__status__').doc('__ping__').get();
    setConnected(true);
  }catch(e){
    setConnected(false);
  }
}, 5000);

/* initial progress */
document.getElementById('progressText').textContent='Welcome — click the globe to contribute';
document.getElementById('progressFillLocal').style.width='18%';

/* Accessibility improvements */
document.addEventListener('keydown', (e)=>{
  if(e.key === 'Escape') {
    // close mobile nav
    mobileNav.style.display = 'none';
  }
});
</script>
</body>
</html>
